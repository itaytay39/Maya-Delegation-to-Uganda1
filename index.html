<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>מפת המשלחת של מאיה</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />

    <style>
        :root {
            --md-sys-primary: #6750A4;
            --md-sys-on-primary: #FFFFFF;
            --md-sys-surface: #FEF7FF;
            --md-sys-on-surface: #1D1B20;
            --md-sys-surface-variant: #E7E0EC;
            --md-sys-on-surface-variant: #49454F;
            --md-sys-shape-xl: 28px;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { height: 100%; overflow: hidden; font-family: 'Heebo', sans-serif; }
        body { background: var(--md-sys-background); color: var(--md-sys-on-background); direction: rtl; }
        
        #app-container, #access-denied-container {
            max-width: 600px; margin: 0 auto; background: var(--md-sys-surface);
            height: 100%; display: flex; flex-direction: column;
        }

        /* --- ACCESS DENIED SCREEN --- */
        #access-denied-container {
            align-items: center; justify-content: center; text-align: center;
            padding: 2rem; display: none;
        }
        .access-denied-icon { font-size: 4rem; color: var(--md-sys-primary); margin-bottom: 1.5rem; }
        .access-denied-title { font-size: 1.75rem; font-weight: 700; margin-bottom: 0.5rem; }
        .access-denied-text { font-size: 1.1rem; color: var(--md-sys-on-surface-variant); line-height: 1.6; }
        
        /* --- MAIN APP (Initially hidden) --- */
        #app-container { display: none; }
        #app-container.visible { display: flex; }

        .header { background: var(--md-sys-surface); padding: 1rem; display: flex; align-items: center; gap: 1rem; border-bottom: 1px solid var(--md-sys-surface-variant); flex-shrink: 0; }
        .logo-maya { width: 48px; height: 48px; border-radius: 50%; }
        .header-title { font-size: 1.25rem; font-weight: 600; }
        .filters-container { padding: 0.5rem 1rem 1rem; background: var(--md-sys-surface); display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; flex-shrink: 0; }
        .input-container { display: flex; align-items: center; gap: 0.5rem; background: var(--md-sys-surface-variant); border-radius: var(--md-sys-shape-xl); padding: 0.5rem 1rem; }
        .input-container .material-symbols-outlined { color: var(--md-sys-on-surface-variant); }
        .search-input, #city-filter { width: 100%; border: none; outline: none; font-size: 1rem; background: transparent; appearance: none; color: var(--md-sys-on-surface-variant); }
        .map-container { flex-grow: 1; position: relative; }
        #map { height: 100%; width: 100%; background: #f0f0f0; }
        .participant-count { position: absolute; top: 1rem; right: 1rem; background: rgba(255,255,255,0.9); padding: 0.5rem 1rem; border-radius: 12px; z-index: 1; font-size: 0.875rem; }
        .gm-style-iw-d { overflow: hidden !important; } .gm-style-iw-c { padding: 0 !important; border-radius: 16px !important; }
        .popup-box { padding: 1rem; text-align: center; max-width: 280px; }
        .popup-name { font-size: 1.25rem; font-weight: 700; color: var(--md-sys-primary); margin-bottom: 0.25rem; }
        .popup-city { font-size: 1rem; color: var(--md-sys-on-surface-variant); margin-bottom: 1rem; }
    </style>
</head>
<body>
    <div id="access-denied-container">
        <span class="material-symbols-outlined access-denied-icon">lock</span>
        <h1 class="access-denied-title">הגישה נחסמה</h1>
        <p class="access-denied-text">נראה שאתה מנסה להיכנס ללא קישור ההזמנה.<br>כדי לראות את המפה, אנא השתמש בקישור שנשלח בקבוצת הוואטסאפ של המשלחת.</p>
    </div>

    <div id="app-container">
        <header class="header">
            <img class="logo-maya" src="https://itaytay39.github.io/Maya-Delegation-to-Uganda1/logo.jpg" alt="לוגו מאיה" onerror="this.style.display='none'">
            <h1 class="header-title">מפת המשלחת</h1>
        </header>
        <div class="filters-container">
            <div class="input-container"><span class="material-symbols-outlined">location_city</span><select id="city-filter"><option value="">כל הערים</option></select></div>
            <div class="input-container"><span class="material-symbols-outlined">search</span><input type="search" id="search-input" placeholder="חיפוש..." class="search-input"></div>
        </div>
        <main class="map-container">
            <div id="map"></div>
            <div id="participant-count" class="participant-count"></div>
        </main>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyD9Dtp32sofmjDfI3aP3lXskTxRUcF9_Cg",
          authDomain: "maya-delegation-to-uganda.firebaseapp.com",
          projectId: "maya-delegation-to-uganda",
          storageBucket: "maya-delegation-to-uganda.appspot.com",
          messagingSenderId: "543677265577",
          appId: "1:543677265577:web:7c8f122ed21f6c5aaadbb8"
        };
        
        const MAGIC_LINK_SECRET = "UgandaJourney2025";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let map;
        let infoWindow;
        let participants = [];

        const elements = {
            appContainer: document.getElementById('app-container'),
            accessDeniedContainer: document.getElementById('access-denied-container'),
            searchInput: document.getElementById('search-input'), 
            cityFilter: document.getElementById('city-filter'),
            participantCount: document.getElementById('participant-count'),
            mapDiv: document.getElementById('map'),
        };

        function checkAccess() {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('access_token') === MAGIC_LINK_SECRET) {
                elements.appContainer.classList.add('visible');
                signInAnonymously(auth)
                    .then(() => {
                        console.log("Signed in anonymously.");
                        initMapAndLogic();
                    })
                    .catch(handleAuthError);
            } else {
                elements.accessDeniedContainer.style.display = 'flex';
            }
        }
        
        function handleAuthError(error) {
             console.error("Authentication failed:", error);
             elements.appContainer.style.display = 'none';
             elements.accessDeniedContainer.style.display = 'flex';
        }

        async function loadDataFromFirestore() {
            try {
                const q = query(collection(db, "participants"));
                const querySnapshot = await getDocs(q);
                participants = [];
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    // Ensure lat and lon are numbers
                    data.lat = parseFloat(data.Lat);
                    data.lon = parseFloat(data.Lon);
                    participants.push(data);
                });
                populateCityFilter();
                applyFilters();
            } catch (error) {
                console.error("Firestore Error:", error);
                alert("שגיאה בטעינת נתוני הקבוצה.");
            }
        }

        async function initMapAndLogic() {
            const { Map, InfoWindow } = await google.maps.importLibrary("maps");
            infoWindow = new InfoWindow();
            
            map = new Map(elements.mapDiv, {
                center: { lat: 31.5, lng: 34.75 }, zoom: 8,
                disableDefaultUI: true, zoomControl: true
            });

            elements.searchInput.addEventListener('input', applyFilters);
            elements.cityFilter.addEventListener('change', applyFilters);
            
            await loadDataFromFirestore();
        }

        function applyFilters() {
            const searchTerm = elements.searchInput.value.trim().toLowerCase();
            const selectedCity = elements.cityFilter.value;
            let filtered = participants;
            if (selectedCity) {
                filtered = filtered.filter(p => p.city === selectedCity);
            }
            if (searchTerm) {
                filtered = filtered.filter(p => p.name && p.name.toLowerCase().includes(searchTerm));
            }
            renderMarkers(filtered);
        }
        
        function populateCityFilter() {
            const cities = [...new Set(participants.map(user => user.city || "לא צוין"))].sort((a,b) => a.localeCompare(b, 'he'));
            elements.cityFilter.innerHTML = '<option value="">כל הערים</option>';
            cities.forEach(city => {
                if (city) {
                    elements.cityFilter.innerHTML += `<option value="${city}">${city}</option>`;
                }
            });
        }
        
        let currentMarkers = [];
        function renderMarkers(list) {
            currentMarkers.forEach(marker => marker.setMap(null));
            currentMarkers = [];
            
            list.forEach(p => {
                if (p.lat && p.lon) {
                    const marker = new google.maps.Marker({ position: { lat: p.lat, lng: p.lon }, map: map });
                    marker.addListener('click', () => {
                        const content = `<div class="popup-box"><h4>${p.name}</h4><p>${p.city}</p></div>`;
                        infoWindow.setContent(content);
                        infoWindow.open({
                            anchor: marker,
                            map,
                        });
                    });
                    currentMarkers.push(marker);
                }
            });
            elements.participantCount.textContent = `${list.length} משתתפים`;
        }
        checkAccess();
    </script>
    <script async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD9Dtp32sofmjDfI3aP3lXskTxRUcF9_Cg"></script>
</body>
</html>
