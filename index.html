<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>משלחת מאיה לאוגנדה</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom CSS for map and overall layout */
        html, body {
            height: 100%;
            margin: 0;
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
            color: #333;
            direction: rtl; /* Right-to-left for Hebrew */
        }
        #app-container {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        header {
            background-color: #2c3e50;
            color: white;
            padding: 1rem 0;
            text-align: center;
            border-bottom-left-radius: 15px;
            border-bottom-right-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        h1 {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }
        .subtitle {
            font-size: 1.2rem;
            margin-bottom: 1rem;
        }
        .main-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 1rem;
        }
        #map {
            width: 95%;
            height: 600px; /* Increased height for better visibility */
            background-color: #e0e0e0;
            border-radius: 15px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            margin-top: 1.5rem;
            margin-bottom: 1.5rem;
            overflow: hidden; /* Ensure rounded corners are applied */
        }
        #user-list {
            background-color: white;
            padding: 1.5rem;
            border-radius: 15px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            width: 95%;
            max-width: 800px;
            margin-top: 1.5rem;
            margin-bottom: 2rem;
        }
        .user-item {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
            padding: 0.75rem;
            border-bottom: 1px solid #eee;
        }
        .user-item:last-child {
            border-bottom: none;
        }
        .user-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background-color: #a0aec0;
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.2rem;
            font-weight: bold;
            margin-left: 1rem; /* Adjust for RTL */
        }
        .user-details {
            text-align: right; /* Adjust for RTL */
        }
        .user-name {
            font-weight: bold;
            font-size: 1.1rem;
        }
        .user-city {
            font-size: 0.9rem;
            color: #555;
        }
        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #2c3e50;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-top: 2rem;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .error-message {
            color: #e74c3c;
            background-color: #fdd;
            border: 1px solid #e74c3c;
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
            text-align: center;
        }
        /* Message box for alerts */
        .message-box-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .message-box-content {
            background-color: white;
            padding: 2rem;
            border-radius: 15px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
            text-align: center;
            max-width: 400px;
            width: 90%;
            position: relative;
        }
        .message-box-close {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 1.5rem;
            cursor: pointer;
            color: #aaa;
        }
    </style>
</head>
<body>
    <div id="app-container">
        <header>
            <div class="flex justify-center mb-2">
                <img src="https://placehold.co/100x100/A0B939/FFFFFF?text=Logo" alt="Delegation Logo" class="w-24 h-24 rounded-full border-4 border-white shadow-lg">
            </div>
            <h1>משלחת מאיה לאוגנדה</h1>
            <p class="subtitle">מיקומי חברי המשלחת על המפה</p>
        </header>

        <main class="main-content">
            <div id="map" class="rounded-lg shadow-lg"></div>
            <div id="user-list" class="rounded-lg shadow-lg">
                <h2 class="text-2xl font-bold mb-4 text-right">רשימת חברי המשלחת (סה"כ: <span id="user-count">0</span>)</h2>
                <div id="users-container">
                    <div class="loading-spinner" id="users-loading"></div>
                    <div id="users-error" class="error-message hidden"></div>
                </div>
            </div>
        </main>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables for Firebase and App ID, provided by Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db;
        let auth;
        let userId;
        let map;
        let markers = [];
        let authReady = false;

        // Custom message box function
        function showMessageBox(message) {
            const overlay = document.createElement('div');
            overlay.className = 'message-box-overlay';
            overlay.innerHTML = `
                <div class="message-box-content">
                    <span class="message-box-close" onclick="this.parentElement.parentElement.remove()">&times;</span>
                    <p>${message}</p>
                </div>
            `;
            document.body.appendChild(overlay);
        }
        window.showMessageBox = showMessageBox; // Make it globally accessible for inline onclick

        // Initialize Firebase
        async function initializeFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log('Firebase user signed in:', userId);
                        authReady = true;
                        // Fetch data once auth is ready
                        fetchUsers();
                    } else {
                        // Sign in anonymously if no token is available or user is signed out
                        try {
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                                userId = auth.currentUser?.uid;
                                console.log('Signed in with custom token:', userId);
                            } else {
                                const anonUser = await signInAnonymously(auth);
                                userId = anonUser.user.uid;
                                console.log('Signed in anonymously:', userId);
                            }
                            authReady = true;
                            fetchUsers();
                        } catch (error) {
                            console.error("Error during Firebase authentication:", error);
                            document.getElementById('users-error').textContent = 'שגיאת אימות Firebase: ' + error.message;
                            document.getElementById('users-error').classList.remove('hidden');
                        }
                    }
                });
            } catch (error) {
                console.error("Error initializing Firebase:", error);
                document.getElementById('users-error').textContent = 'שגיאת אתחול Firebase: ' + error.message;
                document.getElementById('users-error').classList.remove('hidden');
            }
        }

        // Load Google Maps API
        function loadGoogleMapsScript() {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                // Ensure API key is passed securely or through environment variables in production
                // For this example, we'll assume it's available via an environment variable or config.
                // Replace 'YOUR_GOOGLE_MAPS_API_KEY' with your actual API key
                script.src = `https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_MAPS_API_KEY&callback=initMap`;
                script.async = true;
                script.defer = true;
                script.onerror = () => {
                    console.error("Failed to load Google Maps script.");
                    document.getElementById('users-error').textContent = 'שגיאה בטעינת מפות Google. אנא ודא/י שה-API Key נכון.';
                    document.getElementById('users-error').classList.remove('hidden');
                    reject('Failed to load Google Maps script');
                };
                document.head.appendChild(script);
                window.initMap = resolve; // Google Maps will call this global function when loaded
            });
        }

        // Initialize the map
        async function initMap() {
            try {
                await loadGoogleMapsScript(); // Ensure script is loaded before initializing map
                const uganda = { lat: 0.3476, lng: 32.5825 }; // Kampala, Uganda
                map = new google.maps.Map(document.getElementById('map'), {
                    zoom: 7,
                    center: uganda,
                    mapTypeControl: false,
                    streetViewControl: false,
                    fullscreenControl: false,
                    zoomControl: true,
                    gestureHandling: "greedy",
                });
                console.log("Google Map initialized.");
            } catch (error) {
                console.error("Error initializing map:", error);
                document.getElementById('users-error').textContent = 'שגיאה באתחול המפה: ' + error.message;
                document.getElementById('users-error').classList.remove('hidden');
            }
        }

        // Fetch users from Firestore and display on map
        function fetchUsers() {
            if (!db || !authReady || !userId) {
                console.log("Firebase not ready or user not authenticated yet. Skipping data fetch.");
                return;
            }

            const usersRef = collection(db, `artifacts/${appId}/public/data/users`);
            const usersContainer = document.getElementById('users-container');
            const usersLoading = document.getElementById('users-loading');
            const usersError = document.getElementById('users-error');
            const userCountSpan = document.getElementById('user-count');

            usersLoading.classList.remove('hidden');
            usersError.classList.add('hidden');
            usersContainer.innerHTML = ''; // Clear previous users

            onSnapshot(usersRef, (snapshot) => {
                usersLoading.classList.add('hidden');
                if (snapshot.empty) {
                    usersContainer.innerHTML = '<p class="text-center text-gray-500">אין משתמשים להצגה.</p>';
                    userCountSpan.textContent = '0';
                    return;
                }

                const users = [];
                snapshot.forEach(doc => {
                    users.push({ id: doc.id, ...doc.data() });
                });

                userCountSpan.textContent = users.length;
                displayUsers(users);
                updateMapMarkers(users);
            }, (error) => {
                console.error("Error fetching users:", error);
                usersLoading.classList.add('hidden');
                usersError.textContent = 'שגיאה בטעינת משתמשים: ' + error.message;
                usersError.classList.remove('hidden');
            });
        }

        // Display users in the list
        function displayUsers(users) {
            const usersContainer = document.getElementById('users-container');
            usersContainer.innerHTML = ''; // Clear previous users

            users.forEach(user => {
                const userDiv = document.createElement('div');
                userDiv.className = 'user-item';
                userDiv.innerHTML = `
                    <div class="user-avatar">${user.name ? user.name.charAt(0) : '?'}</div>
                    <div class="user-details">
                        <div class="user-name">${user.name || 'משתמש לא ידוע'}</div>
                        <div class="user-city">${user.city || 'עיר לא ידועה'}</div>
                    </div>
                `;
                usersContainer.appendChild(userDiv);
            });
        }

        // Update map markers
        function updateMapMarkers(users) {
            // Clear existing markers
            markers.forEach(marker => marker.setMap(null));
            markers = [];

            const locations = {}; // To group users by location (city, lat, lng)

            users.forEach(user => {
                // Ensure user.location is an object with lat and lng
                if (user.location && typeof user.location.latitude === 'number' && typeof user.location.longitude === 'number') {
                    const key = `${user.location.latitude},${user.location.longitude}`;
                    if (!locations[key]) {
                        locations[key] = [];
                    }
                    locations[key].push(user);
                } else {
                    console.warn(`User ${user.name || user.id} has invalid location data:`, user.location);
                }
            });

            // Add markers with slight offsets for overlapping locations
            for (const key in locations) {
                const group = locations[key];
                const baseLat = group[0].location.latitude;
                const baseLng = group[0].location.longitude;

                group.forEach((user, index) => {
                    // Apply a small offset for each user in the same location
                    // This creates a "cluster" of visible markers around the same point
                    const offsetLat = (index % 3 - 1) * 0.0005; // -0.0005, 0, 0.0005
                    const offsetLng = Math.floor(index / 3) * 0.0005 * (index % 2 === 0 ? 1 : -1);

                    const position = {
                        lat: baseLat + offsetLat,
                        lng: baseLng + offsetLng
                    };

                    const marker = new google.maps.Marker({
                        position: position,
                        map: map,
                        title: user.name || 'משתמש',
                        animation: google.maps.Animation.DROP,
                        // Custom icon (optional, for better visibility)
                        icon: {
                            url: 'https://maps.google.com/mapfiles/ms/icons/red-dot.png', // Default red dot
                            scaledSize: new google.maps.Size(30, 30),
                        }
                    });

                    // Info window for each marker
                    const infoWindowContent = `
                        <div style="direction:rtl; text-align:right;">
                            <h3 style="font-weight:bold; margin-bottom: 5px;">${user.name || 'משתמש לא ידוע'}</h3>
                            <p><strong>עיר:</strong> ${user.city || 'לא ידועה'}</p>
                            <p><strong>תיאור:</strong> ${user.description || 'אין תיאור'}</p>
                        </div>
                    `;
                    const infoWindow = new google.maps.InfoWindow({
                        content: infoWindowContent,
                    });

                    marker.addListener('click', () => {
                        infoWindow.open(map, marker);
                    });

                    markers.push(marker);
                });
            }
        }

        // Initialize the app when the window loads
        window.onload = async function() {
            // Check if Firebase config is available
            if (Object.keys(firebaseConfig).length === 0) {
                showMessageBox('שגיאה: הגדרות Firebase אינן זמינות. אנא ודא/י שהאפליקציה הוגדרה כהלכה.');
                document.getElementById('users-error').textContent = 'שגיאה: הגדרות Firebase אינן זמינות.';
                document.getElementById('users-error').classList.remove('hidden');
                return;
            }

            // Load Google Maps script and then initialize Firebase
            try {
                await loadGoogleMapsScript();
                await initializeFirebase();
                console.log("App initialized successfully.");
            } catch (error) {
                console.error("App initialization failed:", error);
                showMessageBox('שגיאה קריטית באתחול האפליקציה. אנא בדוק/בדקי את קונסולת המפתחים.');
            }
        };
    </script>
</body>
</html>
