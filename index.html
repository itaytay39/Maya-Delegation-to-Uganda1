<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>מפת המשלחת של מאיה</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />

    <style>
        :root {
            --md-sys-primary: #6750A4;
            --md-sys-on-primary: #FFFFFF;
            --md-sys-surface: #FEF7FF;
            --md-sys-on-surface: #1D1B20;
            --md-sys-surface-variant: #E7E0EC;
            --md-sys-on-surface-variant: #49454F;
            --md-sys-shape-xl: 28px;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { height: 100%; overflow: hidden; font-family: 'Heebo', sans-serif; }
        body { background: var(--md-sys-background); color: var(--md-sys-on-background); direction: rtl; }
        
        #app-container, #access-denied-container {
            max-width: 600px; margin: 0 auto; background: var(--md-sys-surface);
            height: 100%; display: flex; flex-direction: column;
        }

        /* --- ACCESS DENIED SCREEN --- */
        #access-denied-container {
            align-items: center; justify-content: center; text-align: center;
            padding: 2rem; display: none; /* נשאר מוסתר כי הסרנו את הצורך באסימון גישה */
        }
        .access-denied-icon { font-size: 4rem; color: var(--md-sys-primary); margin-bottom: 1.5rem; }
        .access-denied-title { font-size: 1.75rem; font-weight: 700; margin-bottom: 0.5rem; }
        .access-denied-text { font-size: 1.1rem; color: var(--md-sys-on-surface-variant); line-height: 1.6; }
        
        /* --- MAIN APP (Initially hidden) --- */
        #app-container { display: none; }
        #app-container.visible { display: flex; }

        .header { background: var(--md-sys-surface); padding: 1rem; display: flex; align-items: center; gap: 1rem; border-bottom: 1px solid var(--md-sys-surface-variant); flex-shrink: 0; }
        .logo-maya { width: 48px; height: 48px; border-radius: 50%; }
        .header-title { font-size: 1.25rem; font-weight: 600; }
        .filters-container { padding: 0.5rem 1rem 1rem; background: var(--md-sys-surface); display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; flex-shrink: 0; }
        .input-container { display: flex; align-items: center; gap: 0.5rem; background: var(--md-sys-surface-variant); border-radius: var(--md-sys-shape-xl); padding: 0.5rem 1rem; }
        .input-container .material-symbols-outlined { color: var(--md-sys-on-surface-variant); }
        .search-input, #city-filter { width: 100%; border: none; outline: none; font-size: 1rem; background: transparent; appearance: none; color: var(--md-sys-on-surface-variant); }
        .map-container { flex-grow: 1; position: relative; }
        #map { height: 100%; width: 100%; background: #f0f0f0; }
        .participant-count { position: absolute; top: 1rem; right: 1rem; background: rgba(255,255,255,0.9); padding: 0.5rem 1rem; border-radius: 12px; z-index: 1; font-size: 0.875rem; }
        .gm-style-iw-d { overflow: hidden !important; } .gm-style-iw-c { padding: 0 !important; border-radius: 16px !important; }
        .popup-box { padding: 1rem; text-align: center; max-width: 280px; }
        .popup-name { font-size: 1.25rem; font-weight: 700; color: var(--md-sys-primary); margin-bottom: 0.25rem; }
        .popup-city { font-size: 1rem; color: var(--md-sys-on-surface-variant); margin-bottom: 1rem; }
        .user-id-display {
            font-size: 0.75rem;
            color: var(--md-sys-on-surface-variant);
            margin-top: 1rem;
            text-align: center;
        }
    </style>
</head>
<body>
    <div id="access-denied-container">
        <span class="material-symbols-outlined access-denied-icon">lock</span>
        <h1 class="access-denied-title">הגישה נחסמה</h1>
        <p class="access-denied-text">נראה שאתה מנסה להיכנס ללא קישור ההזמנה.<br>כדי לראות את המפה, אנא השתמש בקישור שנשלח בקבוצת הוואטסאפ של המשלחת.</p>
    </div>

    <div id="app-container">
        <header class="header">
            <img class="logo-maya" src="https://itaytay39.github.io/Maya-Delegation-to-Uganda1/logo.jpg" alt="לוגו מאיה" onerror="this.style.display='none'">
            <h1 class="header-title">מפת המשלחת</h1>
        </header>
        <div class="filters-container">
            <div class="input-container"><span class="material-symbols-outlined">location_city</span><select id="city-filter"><option value="">כל הערים</option></select></div>
            <div class="input-container"><span class="material-symbols-outlined">search</span><input type="search" id="search-input" placeholder="חיפוש..." class="search-input"></div>
        </div>
        <main class="map-container">
            <div id="map"></div>
            <div id="participant-count" class="participant-count"></div>
        </main>
        <div id="user-id-display" class="user-id-display"></div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, getDocs, query } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // הגדרות Firebase: משתמשים במשתנים גלובליים המסופקים על ידי סביבת הקנבס
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let map;
        let infoWindow;
        let participants = [];
        let userId = 'טוען...'; // משתנה לשמירת ה-userId

        const elements = {
            appContainer: document.getElementById('app-container'),
            accessDeniedContainer: document.getElementById('access-denied-container'),
            searchInput: document.getElementById('search-input'), 
            cityFilter: document.getElementById('city-filter'),
            participantCount: document.getElementById('participant-count'),
            mapDiv: document.getElementById('map'),
            userIdDisplay: document.getElementById('user-id-display'), // אלמנט להצגת userId
        };

        // פונקציה לבדיקת גישה - שונתה כדי לאפשר גישה מיידית
        function checkAccess() {
            // הופך את מיכל האפליקציה לגלוי
            elements.appContainer.classList.add('visible');
            
            // האזנה לשינויי מצב אימות וביצוע פעולות Firestore רק לאחר אימות
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid; // הגדרת userId כ-uid של המשתמש המאומת
                    elements.userIdDisplay.textContent = `מזהה משתמש: ${userId}`;
                    console.log("User authenticated:", userId);
                    await initMapAndLogic(); // אתחול המפה והלוגיקה לאחר הכניסה
                } else {
                    // אם אין משתמש מאומת, נסה להיכנס אנונימית
                    if (typeof __initial_auth_token !== 'undefined') {
                        try {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } catch (error) {
                            handleAuthError(error);
                        }
                    } else {
                        try {
                            await signInAnonymously(auth);
                        } catch (error) {
                            handleAuthError(error);
                        }
                    }
                     // אם עדיין אין משתמש לאחר ניסיון הכניסה, צור מזהה רנדומלי
                    if (!auth.currentUser) {
                        userId = crypto.randomUUID();
                        elements.userIdDisplay.textContent = `מזהה משתמש אורח: ${userId}`;
                        console.log("Signed in anonymously. Map is accessible.");
                        await initMapAndLogic();
                    }
                }
            });
            // מסך "הגישה נחסמה" לא יוצג עוד באופן אוטומטי
        }
        
        function handleAuthError(error) {
             console.error("Authentication failed:", error);
             // במקרה של כשל אימות, נציג הודעה פשוטה במקום מסך הגישה החסומה
             // חשוב: הימנע מ-alert() בפועל. זו רק הדגמה לצורך דיבוג.
             // במערכת אמיתית תשתמש במנגנון UI מותאם אישית.
             // alert("שגיאה באימות Firebase. ייתכן שנתוני המפה לא יוצגו.");
             console.warn("שגיאה באימות Firebase. נתוני המפה עשויים לא להיטען עקב הרשאות.");
             // נמשיך לנסות לטעון את המפה, אך יכול להיות שנתונים לא יופיעו
             // (אם כי ללא אימות תקין, קריאות Firestore ייכשלו)
             initMapAndLogic();
        }

        async function loadDataFromFirestore() {
            try {
                // נתיב הקולקציה שונה כדי להתאים למודל ההרשאות של הקנבס (נתונים ציבוריים)
                const collectionPath = `artifacts/${appId}/public/data/participants`;
                console.log("Attempting to load data from Firestore path:", collectionPath);

                // נמנע משימוש ב-orderBy ב-Firestore כדי למנוע שגיאות אינדקסים, נמיין את הנתונים ב-JS
                const q = collection(db, collectionPath);
                const querySnapshot = await getDocs(q);
                participants = [];
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    // ודא שקווי רוחב ואורך הם מספרים
                    data.lat = parseFloat(data.Lat);
                    data.lon = parseFloat(data.Lon);
                    participants.push(data);
                });
                // מיון הנתונים ב-JavaScript במקום ב-Firestore
                participants.sort((a, b) => (a.name || "").localeCompare(b.name || "", 'he'));

                populateCityFilter();
                applyFilters();
            } catch (error) {
                console.error("Firestore Error:", error);
                // במקום alert, אפשר להציג הודעה ב-UI למשתמש
                // alert("שגיאה בטעינת נתוני הקבוצה. ודא שיש חיבור אינטרנט ושהנתונים קיימים.");
                console.error("שגיאה בטעינת נתוני הקבוצה מ-Firestore. ודא הרשאות וחיבור אינטרנט.");
            }
        }

        async function initMapAndLogic() {
            // טעינה דינמית של ספריית Google Maps API
            // מסתמכים על כך שסביבת הקנבס תספק את המפתח למפות Google באופן אוטומטי
            // או שהוא מוגדר בפרויקט Firebase המשויך ל-appId.
            // הסרנו את הטעינה המפורשת של הסקריפט עם מפתח, כיוון שזה עלול לגרום ל-ApiTargetBlockedMapError.
            if (typeof google === 'undefined' || typeof google.maps === 'undefined' || typeof google.maps.importLibrary === 'undefined') {
                console.warn("Google Maps API is not loaded yet. Waiting...");
                // ניתן להוסיף כאן לוגיקה לטעינה ידנית אם עדיין לא נטען,
                // אך לצורך הדיבוג, נניח שהוא יטען על ידי הסביבה.
                // במצב אמיתי, ייתכן שיהיה צורך לטעון אותו עם מפתח מתאים או להשתמש בדרך אחרת.
                 const script = document.createElement('script');
                 script.src = `https://maps.googleapis.com/maps/api/js?key=${firebaseConfig.apiKey}`; // נחזיר את מפתח ה-API
                 script.async = true;
                 script.defer = true;
                 document.head.appendChild(script);

                 await new Promise((resolve, reject) => {
                     script.onload = resolve;
                     script.onerror = () => {
                         console.error("Failed to load Google Maps script. Check API key restrictions.");
                         reject(new Error("Failed to load Google Maps script."));
                     };
                 });
            }
            
            const { Map, InfoWindow } = await google.maps.importLibrary("maps");
            infoWindow = new InfoWindow();
            
            map = new Map(elements.mapDiv, {
                center: { lat: 31.5, lng: 34.75 }, // מיקום התחלתי: מרכז ישראל בערך
                zoom: 8, // רמת זום התחלתית
                disableDefaultUI: true, // הסתרת פקדי UI ברירת מחדל
                zoomControl: true // הצגת פקד זום בלבד
            });

            // אירועים לפילטרים
            elements.searchInput.addEventListener('input', applyFilters);
            elements.cityFilter.addEventListener('change', applyFilters);
            
            await loadDataFromFirestore();
        }

        // פונקציית סינון והצגה מחדש של הסמנים
        function applyFilters() {
            const searchTerm = elements.searchInput.value.trim().toLowerCase();
            const selectedCity = elements.cityFilter.value;
            let filtered = participants;
            
            // סינון לפי עיר
            if (selectedCity) {
                filtered = filtered.filter(p => p.city === selectedCity);
            }
            // סינון לפי שם
            if (searchTerm) {
                filtered = filtered.filter(p => p.name && p.name.toLowerCase().includes(searchTerm));
            }
            
            renderMarkers(filtered);
        }
        
        // מילוי רשימת הערים בפילטר
        function populateCityFilter() {
            const cities = [...new Set(participants.map(user => user.city || "לא צוין"))].sort((a,b) => a.localeCompare(b, 'he'));
            elements.cityFilter.innerHTML = '<option value="">כל הערים</option>';
            cities.forEach(city => {
                if (city) {
                    elements.cityFilter.innerHTML += `<option value="${city}">${city}</option>`;
                }
            });
        }
        
        let currentMarkers = []; // מערך לשמירת הסמנים הנוכחיים
        // פונקציה להצגת סמנים על המפה
        function renderMarkers(list) {
            // הסרת כל הסמנים הקיימים
            currentMarkers.forEach(marker => marker.setMap(null));
            currentMarkers = [];
            
            list.forEach(p => {
                // ודא שיש נתוני מיקום חוקיים
                if (p.lat && p.lon && !isNaN(p.lat) && !isNaN(p.lon)) {
                    const marker = new google.maps.Marker({ position: { lat: p.lat, lng: p.lon }, map: map });
                    marker.addListener('click', () => {
                        const content = `<div class="popup-box"><div class="popup-name">${p.name}</div><div class="popup-city">${p.city}</div></div>`;
                        infoWindow.setContent(content);
                        infoWindow.open({
                            anchor: marker,
                            map,
                        });
                    });
                    currentMarkers.push(marker);
                }
            });
            // עדכון מונה המשתתפים
            elements.participantCount.textContent = `${list.length} משתתפים`;
        }
        
        // התחל את תהליך בדיקת הגישה (שכעת נותן גישה תמיד)
        checkAccess();
    </script>
</body>
</html>
