<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>מפת המשלחת של מאיה</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />

    <style>
        :root {
            --md-sys-primary: #6750A4;
            --md-sys-on-primary: #FFFFFF;
            --md-sys-surface: #FEF7FF;
            --md-sys-on-surface: #1D1B20;
            --md-sys-surface-variant: #E7E0EC;
            --md-sys-on-surface-variant: #49454F;
            --md-sys-shape-xl: 28px;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { height: 100%; overflow: hidden; font-family: 'Heebo', sans-serif; }
        body { background: var(--md-sys-background); color: var(--md-sys-on-background); direction: rtl; }
        
        #app-container, #access-denied-container {
            max-width: 600px; margin: 0 auto; background: var(--md-sys-surface);
            height: 100%; display: flex; flex-direction: column;
        }

        /* --- ACCESS DENIED SCREEN --- */
        #access-denied-container {
            align-items: center; justify-content: center; text-align: center;
            padding: 2rem; display: none; /* נשאר מוסתר כי הסרנו את הצורך באסימון גישה */
        }
        .access-denied-icon { font-size: 4rem; color: var(--md-sys-primary); margin-bottom: 1.5rem; }
        .access-denied-title { font-size: 1.75rem; font-weight: 700; margin-bottom: 0.5rem; }
        .access-denied-text { font-size: 1.1rem; color: var(--md-sys-on-surface-variant); line-height: 1.6; }
        
        /* --- MAIN APP (Initially hidden) --- */
        #app-container { display: none; }
        #app-container.visible { display: flex; }

        /* --- Updated Header Styling --- */
        .header {
            /* Changed to a lighter, more Google-like gradient */
            background: linear-gradient(135deg, #e0e7ff 0%, #c3daff 100%); /* Light blue/purple gradient */
            padding: 1.5rem 1rem; /* Increased padding */
            display: flex;
            flex-direction: column; /* Stack logo, title, slogan vertically */
            align-items: center; /* Center items horizontally */
            justify-content: center; /* Center items vertically if needed */
            color: #49454F; /* Darker text color for contrast on light background */
            border-bottom: none; /* Removed border */
            flex-shrink: 0;
            text-align: center; /* Ensure text is centered */
        }
        .logo-maya {
            width: 90px; /* Further increased logo size */
            height: 90px; /* Further increased logo size */
            border-radius: 50%;
            margin-bottom: 0.75rem; /* Space between logo and title */
            box-shadow: 0 4px 8px rgba(0,0,0,0.2); /* Added subtle shadow */
            background-color: white; /* Ensure white background for logo */
            padding: 5px; /* Small padding around the image inside the circle */
            object-fit: contain; /* Ensure the image fits within the circle */
        }
        .header-title {
            font-size: 1.75rem; /* Larger title */
            font-weight: 700; /* Bolder title */
            margin-bottom: 0.25rem; /* Space between title and slogan */
            color: var(--md-sys-on-surface); /* Ensure good contrast */
        }
        .header-slogan {
            font-size: 1rem; /* Slogan font size */
            font-weight: 400; /* Normal weight */
            color: var(--md-sys-on-surface-variant); /* Adjusted slogan color for contrast */
        }

        .filters-container { padding: 0.5rem 1rem 1rem; background: var(--md-sys-surface); display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; flex-shrink: 0; }
        .input-container { display: flex; align-items: center; gap: 0.5rem; background: var(--md-sys-surface-variant); border-radius: var(--md-sys-shape-xl); padding: 0.5rem 1rem; }
        .input-container .material-symbols-outlined { color: var(--md-sys-on-surface-variant); }
        .search-input, #city-filter { width: 100%; border: none; outline: none; font-size: 1rem; background: transparent; appearance: none; color: var(--md-sys-on-surface-variant); }
        .map-container { flex-grow: 1; position: relative; }
        #map { height: 100%; width: 100%; background: #f0f0f0; display: flex; align-items: center; justify-content: center;} /* Added flex properties for centering error message */
        .participant-count { position: absolute; top: 1rem; right: 1rem; background: rgba(255,255,255,0.9); padding: 0.5rem 1rem; border-radius: 12px; z-index: 1; font-size: 0.875rem; }
        .gm-style-iw-d { overflow: hidden !important; } .gm-style-iw-c { padding: 0 !important; border-radius: 16px !important; }
        .popup-box { padding: 1rem; text-align: center; max-width: 280px; }
        .popup-name { font-size: 1.25rem; font-weight: 700; color: var(--md-sys-primary); margin-bottom: 0.25rem; }
        .popup-city { font-size: 1rem; color: var(--md-sys-on-surface-variant); margin-bottom: 1rem; }
        .user-id-display {
            font-size: 0.75rem;
            color: var(--md-sys-on-surface-variant);
            margin-top: 1rem;
            text-align: center;
        }
    </style>
</head>
<body>
    <div id="access-denied-container">
        <span class="material-symbols-outlined access-denied-icon">lock</span>
        <h1 class="access-denied-title">הגישה נחסמה</h1>
        <p class="access-denied-text">נראה שאתה מנסה להיכנס ללא קישור ההזמנה.<br>כדי לראות את המפה, אנא השתמש בקישור שנשלח בקבוצת הוואטסאפ של המשלחת.</p>
    </div>

    <div id="app-container">
        <header class="header">
            <!-- לוגו מאיה - מותאם למראה החדש -->
            <img class="logo-maya" src="https://itaytay39.github.io/Maya-Delegation-to-Uganda1/logo.jpg" alt="לוגו מאיה" onerror="this.style.display='none'">
            <!-- כותרת ראשית -->
            <h1 class="header-title">מאיה - משלחת לאוגנדה</h1>
            <!-- סלוגן - נוסף בהתאם לבקשתך -->
            <p class="header-slogan">מחברים בין חברים</p>
        </header>
        <div class="filters-container">
            <div class="input-container"><span class="material-symbols-outlined">location_city</span><select id="city-filter"><option value="">כל הערים</option></select></div>
            <div class="input-container"><span class="material-symbols-outlined">search</span><input type="search" id="search-input" placeholder="חיפוש..." class="search-input"></div>
        </div>
        <main class="map-container">
            <div id="map"></div>
            <div id="participant-count" class="participant-count"></div>
        </main>
        <div id="user-id-display" class="user-id-display"></div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, getDocs, query } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // הגדרות Firebase: כעת נשתמש במפתח ה-API שהוזן ישירות על ידי המשתמש
        // ודא שמפתח ה-API שהעתקת מ-Google Cloud Console מודבק כאן במקום 'YOUR_API_KEY_HERE'.
        // וודא שגם 'projectId' הוא מזהה הפרויקט הנכון שלך (maya-delegation-map).
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'; // עדיין משתמשים ב-appId מהסביבה
        const firebaseConfig = {
          apiKey: "AIzaSyCEo0QBID_qOEivVCmbcg8Z_YYY4cIjwj0", // מפתח ה-API שעודכן על ידך
          authDomain: "maya-delegation-map.firebaseapp.com", // ודא שזהו הדומיין הנכון של הפרויקט החדש
          projectId: "maya-delegation-map", // ודא שזהו מזהה הפרויקט החדש שלך
          storageBucket: "maya-delegation-map.appspot.com",
          messagingSenderId: "543677265577", // ייתכן שיצטרך להתעדכן לפי הפרויקט החדש
          appId: "1:543677265577:web:7c8f122ed21f6c5aaadbb8" // ייתכן שיצטרך להתעדכן לפי הפרויקט החדש
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let map;
        let infoWindow;
        let participants = [];
        let userId = 'טוען...'; // משתנה לשמירת ה-userId

        const elements = {
            appContainer: document.getElementById('app-container'),
            accessDeniedContainer: document.getElementById('access-denied-container'),
            searchInput: document.getElementById('search-input'), 
            cityFilter: document.getElementById('city-filter'),
            participantCount: document.getElementById('participant-count'),
            mapDiv: document.getElementById('map'),
            userIdDisplay: document.getElementById('user-id-display'), // אלמנט להצגת userId
        };

        // פונקציה לבדיקת גישה - שונתה כדי לאפשר גישה מיידית
        function checkAccess() {
            // הופך את מיכל האפליקציה לגלוי
            elements.appContainer.classList.add('visible');
            
            // האזנה לשינויי מצב אימות וביצוע פעולות Firestore רק לאחר אימות
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid; // הגדרת userId כ-uid של המשתמש המאומת
                    elements.userIdDisplay.textContent = `מזהה משתמש: ${userId}`;
                    console.log("User authenticated:", userId);
                    await initMapAndLogic(); // אתחול המפה והלוגיקה לאחר הכניסה
                } else {
                    // אם אין משתמש מאומת, נסה להיכנס אנונימית
                    if (typeof __initial_auth_token !== 'undefined') {
                        try {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } catch (error) {
                            handleAuthError(error);
                        }
                    } else {
                        try {
                            await signInAnonymously(auth);
                        } catch (error) {
                            handleAuthError(error);
                        }
                    }
                     // אם עדיין אין משתמש לאחר ניסיון הכניסה, צור מזהה רנדומלי
                    if (!auth.currentUser) {
                        userId = crypto.randomUUID();
                        elements.userIdDisplay.textContent = `מזהה משתמש אורח: ${userId}`;
                        console.log("Signed in anonymously. Map is accessible.");
                        await initMapAndLogic();
                    }
                }
            });
            // מסך "הגישה נחסמה" לא יוצג עוד באופן אוטומטי
        }
        
        function handleAuthError(error) {
             console.error("Authentication failed:", error);
             // במקרה של כשל אימות, נציג הודעה בקונסול.
             console.warn("שגיאה באימות Firebase. נתוני המפה עשויים לא להיטען עקב הרשאות.");
             // נמשיך לנסות לטעון את המפה, אך קריאות Firestore ייכשלו ללא אימות תקין.
             initMapAndLogic();
        }

        async function loadDataFromFirestore() {
            try {
                // נתיב הקולקציה שונה כדי להתאים למודל ההרשאות של הקנבס (נתונים ציבוריים)
                const collectionPath = `artifacts/${appId}/public/data/participants`;
                console.log("Attempting to load data from Firestore path:", collectionPath);

                // נמנע משימוש ב-orderBy ב-Firestore כדי למנוע שגיאות אינדקסים, נמיין את הנתונים ב-JS
                const q = collection(db, collectionPath);
                const querySnapshot = await getDocs(q);
                participants = [];
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    // ודא שקווי רוחב ואורך הם מספרים
                    data.lat = parseFloat(data.Lat);
                    data.lon = parseFloat(data.Lon);
                    participants.push(data);
                });
                // מיון הנתונים ב-JavaScript במקום ב-Firestore
                participants.sort((a, b) => (a.name || "").localeCompare(b.name || "", 'he'));

                populateCityFilter();
                applyFilters();
            } catch (error) {
                console.error("Firestore Error:", error);
                // במקרה של שגיאה בטעינת נתונים, נציג הודעה ב-UI למשתמש
                elements.mapDiv.innerHTML = `<div style="text-align: center; padding: 20px; color: #DC3545;">
                    <h1 style="font-size: 1.5rem; margin-bottom: 10px;">שגיאה בטעינת נתוני הקבוצה</h1>
                    <p style="font-size: 1rem;">נא לוודא שיש חיבור אינטרנט ושהרשאות הגישה ל-Firestore מוגדרות כראוי עבור המשתמש הנוכחי. (ראה קונסולת מפתחים לפרטים)</p>
                </div>`;
            }
        }

        async function initMapAndLogic() {
            // שגיאת 'ApiTargetBlockedMapError' מצביעה לרוב על כך שמפתח ה-API
            // אינו מוגדר כראוי עבור Google Maps JavaScript API בחשבון Google Cloud,
            // או שיש לו הגבלות HTTP referrer שחוסמות את הדומיין הנוכחי.
            // הקוד כאן מוודא שהסקריפט נטען עם המפתח המצוין ב-firebaseConfig.
            
            // בודק אם ספריית google.maps כבר נטענה
            if (typeof google === 'undefined' || typeof google.maps === 'undefined' || typeof google.maps.importLibrary === 'undefined') {
                console.warn("Google Maps API is not loaded yet. Attempting to load dynamically...");
                const script = document.createElement('script');
                // שימוש במפתח ה-API מ-firebaseConfig
                script.src = `https://maps.googleapis.com/maps/api/js?key=${firebaseConfig.apiKey}&libraries=maps`; // הוספת libraries=maps
                script.async = true;
                script.defer = true;
                document.head.appendChild(script);

                try {
                    await new Promise((resolve, reject) => {
                        script.onload = () => {
                            // ודא ש-google.maps.importLibrary זמין לפני ה-resolve
                            if (typeof google !== 'undefined' && typeof google.maps !== 'undefined' && typeof google.maps.importLibrary === 'function') {
                                resolve();
                            } else {
                                reject(new Error("Google Maps script loaded, but importLibrary is not available."));
                            }
                        };
                        script.onerror = () => {
                            console.error("Failed to load Google Maps script. This often means the API key is invalid or not enabled for Google Maps JavaScript API.");
                            reject(new Error("Failed to load Google Maps script."));
                        };
                    });
                    console.log("Google Maps script loaded successfully.");
                } catch (error) {
                    console.error("Error during Google Maps script loading:", error);
                    // אם הסקריפט לא נטען, אין טעם להמשיך עם מפות Google
                    elements.mapDiv.innerHTML = `<div style="text-align: center; padding: 20px; color: #DC3545;">
                        <h1 style="font-size: 1.5rem; margin-bottom: 10px;">שגיאה בטעינת ספריית המפות</h1>
                        <p style="font-size: 1rem;">ייתכן שמפתח ה-API של Google Maps אינו תקין או שאינו מוגדר כראוי בחשבון Google Cloud.</p>
                        <p style="font-size: 0.8rem;">אנא בדוק את <a href="https://console.cloud.google.com/apis/credentials" target="_blank" style="color: #6750A4;">קונסולת Google Cloud</a> עבור הגבלות מפתח API (HTTP referrers) ואפשר את "Maps JavaScript API".</p>
                    </div>`;
                    return; 
                }
            } else {
                console.log("Google Maps API already loaded.");
            }
            
            try {
                // נמשיך לנסות לטעון את ספריית "maps" גם אם היא כבר נטענה דרך הסקריפט, כדי לוודא שכל הפונקציות זמינות.
                const { Map, InfoWindow } = await google.maps.importLibrary("maps");
                infoWindow = new InfoWindow();
                
                map = new Map(elements.mapDiv, {
                    center: { lat: 31.5, lng: 34.75 }, // מיקום התחלתי: מרכז ישראל בערך
                    zoom: 8, // רמת זום התחלתית
                    disableDefaultUI: true, // הסתרת פקדי UI ברירת מחדל
                    zoomControl: true // הצגת פקד זום בלבד
                });
                console.log("Google Map initialized.");
            } catch (error) {
                console.error("Error initializing Google Map. This might be due to API key restrictions or other configuration issues:", error);
                // הצגת הודעה ב-UI למשתמש אם המפה לא מצליחה להיטען
                elements.mapDiv.innerHTML = `<div style="text-align: center; padding: 20px; color: #DC3545;">
                    <h1 style="font-size: 1.5rem; margin-bottom: 10px;">שגיאה באתחול המפה</h1>
                    <p style="font-size: 1rem;">נא לוודא שמפתח ה-API של Google Maps תקין ומוגדר כראוי עבור דומיין זה.</p>
                    <p style="font-size: 0.8rem;">אנא בדוק את <a href="https://console.cloud.google.com/apis/credentials" target="_blank" style="color: #6750A4;">קונסולת Google Cloud</a> עבור הגבלות מפתח API.</p>
                </div>`;
                return; // יציאה מהפונקציה אם המפה לא נטענה
            }


            // אירועים לפילטרים
            elements.searchInput.addEventListener('input', applyFilters);
            elements.cityFilter.addEventListener('change', applyFilters);
            
            await loadDataFromFirestore();
        }

        // פונקציית סינון והצגה מחדש של הסמנים
        function applyFilters() {
            const searchTerm = elements.searchInput.value.trim().toLowerCase();
            const selectedCity = elements.cityFilter.value;
            let filtered = participants;
            
            // סינון לפי עיר
            if (selectedCity) {
                filtered = filtered.filter(p => p.city === selectedCity);
            }
            // סינון לפי שם
            if (searchTerm) {
                filtered = filtered.filter(p => p.name && p.name.toLowerCase().includes(searchTerm));
            }
            
            renderMarkers(filtered);
        }
        
        // מילוי רשימת הערים בפילטר
        function populateCityFilter() {
            const cities = [...new Set(participants.map(user => user.city || "לא צוין"))].sort((a,b) => a.localeCompare(b, 'he'));
            elements.cityFilter.innerHTML = '<option value="">כל הערים</option>';
            cities.forEach(city => {
                if (city) {
                    elements.cityFilter.innerHTML += `<option value="${city}">${city.charAt(0).toUpperCase() + city.slice(1)}</option>`; // Capitalize first letter for display
                }
            });
        }
        
        let currentMarkers = []; // מערך לשמירת הסמנים הנוכחיים
        // פונקציה להצגת סמנים על המפה
        function renderMarkers(list) {
            // הסרת כל הסמנים הקיימים
            currentMarkers.forEach(marker => marker.setMap(null));
            currentMarkers = [];
            
            list.forEach(p => {
                // ודא שיש נתוני מיקום חוקיים
                if (p.lat && p.lon && !isNaN(p.lat) && !isNaN(p.lon)) {
                    const marker = new google.maps.Marker({ position: { lat: p.lat, lng: p.lon }, map: map });
                    marker.addListener('click', () => {
                        const content = `<div class="popup-box"><div class="popup-name">${p.name}</div><div class="popup-city">${p.city}</div></div>`;
                        infoWindow.setContent(content);
                        infoWindow.open({
                            anchor: marker,
                            map,
                        });
                    });
                    currentMarkers.push(marker);
                }
            });
            // עדכון מונה המשתתפים
            elements.participantCount.textContent = `${list.length} משתתפים`;
        }
        
        // התחל את תהליך בדיקת הגישה (שכעת נותן גישה תמיד)
        checkAccess();
    </script>
</body>
</html>
