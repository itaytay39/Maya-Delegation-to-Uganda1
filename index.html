<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>מפת המשלחת של מאיה</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />

    <style>
        :root {
            --md-sys-primary: #6750A4;
            --md-sys-on-primary: #FFFFFF;
            --md-sys-surface: #FEF7FF;
            --md-sys-on-surface: #1D1B20;
            --md-sys-surface-variant: #E7E0EC;
            --md-sys-on-surface-variant: #49454F;
            --md-sys-shape-xl: 28px;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { height: 100%; overflow: hidden; font-family: 'Heebo', sans-serif; }
        body { background: var(--md-sys-background); color: var(--md-sys-on-background); direction: rtl; }
        
        #app-container, #access-denied-container {
            max-width: 600px; margin: 0 auto; background: var(--md-sys-surface);
            height: 100%; display: flex; flex-direction: column;
        }

        /* --- ACCESS DENIED SCREEN --- */
        #access-denied-container {
            align-items: center; justify-content: center; text-align: center;
            padding: 2rem; display: none; /* נשאר מוסתר כי הסרנו את הצורך באסימון גישה */
        }
        .access-denied-icon { font-size: 4rem; color: var(--md-sys-primary); margin-bottom: 1.5rem; }
        .access-denied-title { font-size: 1.75rem; font-weight: 700; margin-bottom: 0.5rem; }
        .access-denied-text { font-size: 1.1rem; color: var(--md-sys-on-surface-variant); line-height: 1.6; }
        
        /* --- MAIN APP (Initially hidden) --- */
        #app-container { display: none; }
        #app-container.visible { display: flex; }

        /* --- Updated Header Styling --- */
        .header {
            /* Changed to a lighter, more Google-like gradient */
            background: linear-gradient(135deg, #e0e7ff 0%, #c3daff 100%); /* Light blue/purple gradient */
            padding: 1.5rem 1rem; /* Increased padding */
            display: flex;
            flex-direction: column; /* Stack logo, title, slogan vertically */
            align-items: center; /* Center items horizontally */
            justify-content: center; /* Center items vertically if needed */
            color: #49454F; /* Darker text color for contrast on light background */
            border-bottom: none; /* Removed border */
            flex-shrink: 0;
            text-align: center; /* Ensure text is centered */
        }
        .logo-maya {
            width: 90px; /* Further increased logo size */
            height: 90px; /* Further increased logo size */
            border-radius: 50%;
            margin-bottom: 0.75rem; /* Space between logo and title */
            box-shadow: 0 4px 8px rgba(0,0,0,0.2); /* Added subtle shadow */
            background-color: white; /* Ensure white background for logo */
            padding: 5px; /* Small padding around the image inside the circle */
            object-fit: contain; /* Ensure the image fits within the circle */
        }
        .header-title {
            font-size: 1.75rem; /* Larger title */
            font-weight: 700; /* Bolder title */
            margin-bottom: 0.25rem; /* Space between title and slogan */
            color: var(--md-sys-on-surface); /* Ensure good contrast */
        }
        .header-slogan {
            font-size: 1rem; /* Slogan font size */
            font-weight: 400; /* Normal weight */
            color: var(--md-sys-on-surface-variant); /* Adjusted slogan color for contrast */
        }

        .filters-container { padding: 0.5rem 1rem 1rem; background: var(--md-sys-surface); display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; flex-shrink: 0; }
        .input-container { display: flex; align-items: center; gap: 0.5rem; background: var(--md-sys-surface-variant); border-radius: var(--md-sys-shape-xl); padding: 0.5rem 1rem; }
        .input-container .material-symbols-outlined { color: var(--md-sys-on-surface-variant); }
        .search-input, #city-filter { width: 100%; border: none; outline: none; font-size: 1rem; background: transparent; appearance: none; color: var(--md-sys-on-surface-variant); }
        .map-container { flex-grow: 1; position: relative; }
        #map { height: 100%; width: 100%; background: #f0f0f0; display: flex; align-items: center; justify-content: center;} /* Added flex properties for centering error message */
        .participant-count { position: absolute; top: 1rem; right: 1rem; background: rgba(255,255,255,0.9); padding: 0.5rem 1rem; border-radius: 12px; z-index: 1; font-size: 0.875rem; }
        .gm-style-iw-d { overflow: hidden !important; } .gm-style-iw-c { padding: 0 !important; border-radius: 16px !important; }
        .popup-box { padding: 1rem; text-align: center; max-width: 280px; }
        .popup-name { font-size: 1.25rem; font-weight: 700; color: var(--md-sys-primary); margin-bottom: 0.25rem; }
        .popup-city { font-size: 1rem; color: var(--md-sys-on-surface-variant); margin-bottom: 1rem; }
        .user-id-display {
            font-size: 0.75rem;
            color: var(--md-sys-on-surface-variant);
            margin-top: 1rem;
            text-align: center;
        }
    </style>
</head>
<body>
    <div id="access-denied-container">
        <span class="material-symbols-outlined access-denied-icon">lock</span>
        <h1 class="access-denied-title">הגישה נחסמה</h1>
        <p class="access-denied-text">נראה שאתה מנסה להיכנס ללא קישור ההזמנה.<br>כדי לראות את המפה, אנא השתמש בקישור שנשלח בקבוצת הוואטסאפ של המשלחת.</p>
    </div>

    <div id="app-container">
        <header class="header">
            <!-- לוגו מאיה - מותאם למראה החדש -->
            <img class="logo-maya" src="https://itaytay39.github.io/Maya-Delegation-to-Uganda1/logo.jpg" alt="לוגו מאיה" onerror="this.style.display='none'">
            <!-- כותרת ראשית -->
            <h1 class="header-title">מאיה - משלחת לאוגנדה</h1>
            <!-- סלוגן - נוסף בהתאם לבקשתך -->
            <p class="header-slogan">מחברים בין חברים</p>
        </header>
        <div class="filters-container">
            <div class="input-container"><span class="material-symbols-outlined">location_city</span><select id="city-filter"><option value="">כל הערים</option></select></div>
            <div class="input-container"><span class="material-symbols-outlined">search</span><input type="search" id="search-input" placeholder="חיפוש..." class="search-input"></div>
        </div>
        <main class="map-container">
            <div id="map"></div>
            <div id="participant-count" class="participant-count"></div>
        </main>
        <div id="user-id-display" class="user-id-display"></div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, getDocs, query } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // הגדרות Firebase: אובייקט firebaseConfig המדויק מפרויקט Firebase שלך
        // זהו התיקון לשגיאת "auth/configuration-not-found"
        const firebaseConfig = {
            apiKey: "AIzaSyCQc9P30rQmjoR9rsAPF1XrTiBwCF9_Cg",
            authDomain: "maya-delegation-to-uganda.firebaseapp.com",
            projectId: "maya-delegation-to-uganda",
            storageBucket: "maya-delegation-to-uganda.appspot.com",
            messagingSenderId: "543677265577",
            appId: "1:543677265577:web:2d9f122e2b545dff6b"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let map;
        let infoWindow;
        let participants = [];
        let userId = 'טוען...'; 
        let googleMapsScriptLoaded = false; // Flag to prevent multiple script loads

        const elements = {
            appContainer: document.getElementById('app-container'),
            accessDeniedContainer: document.getElementById('access-denied-container'),
            searchInput: document.getElementById('search-input'), 
            cityFilter: document.getElementById('city-filter'),
            participantCount: document.getElementById('participant-count'),
            mapDiv: document.getElementById('map'),
            userIdDisplay: document.getElementById('user-id-display'), 
        };

        // פונקציה לבדיקת גישה - שונתה כדי לאפשר גישה מיידית
        function checkAccess() {
            elements.appContainer.classList.add('visible');
            
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid; 
                    elements.userIdDisplay.textContent = `מזהה משתמש: ${userId}`;
                    console.log("User authenticated:", userId);
                    await initMapAndLogic(); 
                } else {
                    // Sign in anonymously if no custom token is provided
                    try {
                        await signInAnonymously(auth);
                        userId = auth.currentUser?.uid || crypto.randomUUID(); // Ensure userId is set
                        elements.userIdDisplay.textContent = `מזהה משתמש אורח: ${userId}`;
                        console.log("Signed in anonymously. Map is accessible.");
                        await initMapAndLogic();
                    } catch (error) {
                        handleAuthError(error);
                    }
                }
            });
        }
        
        function handleAuthError(error) {
             console.error("Authentication failed:", error);
             console.warn("שגיאה באימות Firebase. נתוני המפה עשויים לא להיטען עקב הרשאות.");
             
             let errorMessage = '';
             if (error.code === 'auth/identity-toolkit-api-has-not-been-used-in-project' || error.code === 'auth/api-key-not-valid' || error.code === 'auth/configuration-not-found') {
                 errorMessage = `
                     <h1 style="font-size: 1.5rem; margin-bottom: 10px;">שגיאת אימות Firebase</h1>
                     <p style="font-size: 1rem;">נא לוודא שכל הגדרות ה-Firebase (apiKey, authDomain וכו') נכונות בקוד, וכי 'Identity Toolkit API' מופעל בפרויקט שלך ב-Google Cloud Console.</p>
                     <p style="font-size: 0.8rem;">עבור ל-Firebase Console -> הגדרות פרויקט -> האפליקציות שלך, והעתק את "Firebase SDK snippet" בתצורת "Config".</p>
                     <p style="font-size: 0.8rem;">וודא גם ש-'Identity Toolkit API' מופעל: <a href="https://console.developers.google.com/apis/api/identitytoolkit.googleapis.com/overview?project=${firebaseConfig.projectId}" target="_blank" style="color: #6750A4;">הפעל Identity Toolkit API</a></p>
                 `;
             } else if (error.code === 'auth/requests-from-referer-blocked') {
                  const currentUrl = window.location.href.split('?')[0]; 
                  errorMessage = `
                        <h1 style="font-size: 1.5rem; margin-bottom: 10px;">שגיאה: בקשות Firebase נחסמו</h1>
                        <p style="font-size: 1rem;">נראה שהכתובת הנוכחית של האתר אינה מורשית עבור Firebase Authentication.</p>
                        <p style="font-size: 0.8rem;">אנא הוסף את הכתובת הבאה (או את דומיין הבסיס שלה עם כוכבית) להגבלות ה-HTTP referrers בחשבון Google Cloud, עבור מפתח ה-API שלך:</p>
                        <p style="font-size: 0.9rem; font-weight: bold; color: #333;"><code>${currentUrl.split('/').slice(0, 3).join('/')}/*</code></p>
                        <p style="font-size: 0.8rem;">עבור אל <a href="https://console.cloud.google.com/apis/credentials" target="_blank" style="color: #6750A4;">קונסולת Google Cloud (אישורי כניסה)</a> ועדכן את ההגבלות עבור מפתח ה-API שלך.</p>
                    `;
             } else {
                 errorMessage = `
                    <h1 style="font-size: 1.5rem; margin-bottom: 10px;">שגיאה באימות</h1>
                    <p style="font-size: 1rem;">שגיאת אימות ב-Firebase. בדוק את הגדרות הפרויקט והרשאות. (קוד שגיאה: ${error.code})</p>
                `;
             }
             elements.mapDiv.innerHTML = `<div style="text-align: center; padding: 20px; color: #DC3545;">${errorMessage}</div>`;
        }

        async function loadDataFromFirestore() {
            try {
                // נתיב הקולקציה שונה ל"participants" בלבד
                // כדי להתאים למיקום הנתונים בפועל במסד הנתונים של המשתמש, כפי שנראה בצילום המסך.
                // אם הנתונים יהיו בנתיב מורכב יותר בעתיד, יש לעדכן זאת.
                const collectionPath = `participants`; 
                console.log("Attempting to load data from Firestore path:", collectionPath);

                const q = collection(db, collectionPath);
                const querySnapshot = await getDocs(q);
                participants = [];
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    data.lat = parseFloat(data.Lat);
                    data.lon = parseFloat(data.Lon);
                    // מוודאים שנתוני מיקום קיימים ותקינים לפני הוספה
                    if (!isNaN(data.lat) && !isNaN(data.lon)) {
                         participants.push(data);
                    } else {
                        console.warn("Participant data missing valid Lat/Lon:", data);
                    }
                });
                participants.sort((a, b) => (a.name || "").localeCompare(b.name || "", 'he'));

                populateCityFilter();
                applyFilters();
            } catch (error) {
                console.error("Firestore Error:", error);
                elements.mapDiv.innerHTML = `<div style="text-align: center; padding: 20px; color: #DC3545;">
                    <h1 style="font-size: 1.5rem; margin-bottom: 10px;">שגיאה בטעינת נתוני הקבוצה</h1>
                    <p style="font-size: 1rem;">נא לוודא שיש חיבור אינטרנט, שהרשאות הגישה ל-Firestore מוגדרות כראוי, ושהנתונים נמצאים בנתיב הנכון: 'participants'.</p>
                    <p style="font-size: 0.8rem;">(ראה קונסולת מפתחים לפרטים)</p>
                </div>`;
            }
        }

        async function initMapAndLogic() {
            if (!googleMapsScriptLoaded) {
                console.warn("Google Maps API is not loaded yet. Attempting to load dynamically...");
                const script = document.createElement('script');
                script.src = `https://maps.googleapis.com/maps/api/js?key=${firebaseConfig.apiKey}&libraries=maps`; 
                script.async = true;
                script.defer = true;
                document.head.appendChild(script);

                try {
                    await new Promise((resolve, reject) => {
                        script.onload = () => {
                            if (typeof google !== 'undefined' && typeof google.maps !== 'undefined' && typeof google.maps.importLibrary === 'function') {
                                googleMapsScriptLoaded = true; 
                                resolve();
                            } else {
                                reject(new Error("Google Maps script loaded, but importLibrary is not available."));
                            }
                        };
                        script.onerror = () => {
                            console.error("Failed to load Google Maps script. This often means the API key is invalid or not enabled for Google Maps JavaScript API.");
                            reject(new Error("Failed to load Google Maps script."));
                        };
                    });
                    console.log("Google Maps script loaded successfully.");
                } catch (error) {
                    console.error("Error during Google Maps script loading:", error);
                    elements.mapDiv.innerHTML = `<div style="text-align: center; padding: 20px; color: #DC3545;">
                        <h1 style="font-size: 1.5rem; margin-bottom: 10px;">שגיאה בטעינת ספריית המפות</h1>
                        <p style="font-size: 1rem;">ייתכן שמפתח ה-API של Google Maps אינו תקין או שאינו מוגדר כראוי בחשבון Google Cloud.</p>
                        <p style="font-size: 0.8rem;">אנא בדוק את <a href="https://console.cloud.google.com/apis/credentials" target="_blank" style="color: #6750A4;">קונסולת Google Cloud</a> עבור הגבלות מפתח API (HTTP referrers) ואפשר את "Maps JavaScript API".</p>
                    </div>`;
                    return; 
                }
            } else {
                console.log("Google Maps API already loaded (skipped dynamic load).");
            }
            
            try {
                const { Map, InfoWindow } = await google.maps.importLibrary("maps");
                infoWindow = new InfoWindow();
                
                map = new Map(elements.mapDiv, {
                    center: { lat: 31.5, lng: 34.75 }, 
                    zoom: 8, 
                    disableDefaultUI: true, 
                    zoomControl: true 
                });
                console.log("Google Map initialized.");
            } catch (error) {
                console.error("Error initializing Google Map. This might be due to API key restrictions or other configuration issues:", error);
                if (error.code === 'RefererNotAllowedMapError') {
                    const currentUrl = window.location.href.split('?')[0]; 
                    elements.mapDiv.innerHTML = `<div style="text-align: center; padding: 20px; color: #DC3545;">
                        <h1 style="font-size: 1.5rem; margin-bottom: 10px;">שגיאה: דומיין לא מורשה למפות Google</h1>
                        <p style="font-size: 1rem;">נראה שהכתובת הנוכחית של האתר אינה מורשית עבור מפתח ה-API של מפות Google שלך.</p>
                        <p style="font-size: 0.8rem;">אנא הוסף את הכתובת הבאה (או את דומיין הבסיס שלה עם כוכבית) להגבלות ה-HTTP referrers בחשבון Google Cloud:</p>
                        <p style="font-size: 0.9rem; font-weight: bold; color: #333;"><code>${currentUrl.split('/').slice(0, 3).join('/')}/*</code></p>
                        <p style="font-size: 0.8rem;">עבור אל <a href="https://console.cloud.google.com/apis/credentials" target="_blank" style="color: #6750A4;">קונסולת Google Cloud (אישורי כניסה)</a> ועדכן את ההגבלות עבור מפתח ה-API שלך.</p>
                    </div>`;
                } else {
                    elements.mapDiv.innerHTML = `<div style="text-align: center; padding: 20px; color: #DC3545;">
                        <h1 style="font-size: 1.5rem; margin-bottom: 10px;">שגיאה באתחול המפה</h1>
                        <p style="font-size: 1rem;">נא לוודא שמפתח ה-API של Google Maps תקין ומוגדר כראוי עבור דומיין זה.</p>
                        <p style="font-size: 0.8rem;">אנא בדוק את <a href="https://console.cloud.google.com/apis/credentials" target="_blank" style="color: #6750A4;">קונסולת Google Cloud</a> עבור הגבלות מפתח API.</p>
                    </div>`;
                }
                return; 
            }

            elements.searchInput.addEventListener('input', applyFilters);
            elements.cityFilter.addEventListener('change', applyFilters);
            
            await loadDataFromFirestore();
        }

        function applyFilters() {
            const searchTerm = elements.searchInput.value.trim().toLowerCase();
            const selectedCity = elements.cityFilter.value;
            let filtered = participants;
            
            if (selectedCity) {
                filtered = filtered.filter(p => p.city === selectedCity);
            }
            if (searchTerm) {
                filtered = filtered.filter(p => p.name && p.name.toLowerCase().includes(searchTerm));
            }
            
            renderMarkers(filtered);
        }
        
        function populateCityFilter() {
            const cities = [...new Set(participants.map(user => user.city || "לא צוין"))].sort((a,b) => a.localeCompare(b, 'he'));
            elements.cityFilter.innerHTML = '<option value="">כל הערים</option>';
            cities.forEach(city => {
                if (city) {
                    elements.cityFilter.innerHTML += `<option value="${city}">${city.charAt(0).toUpperCase() + city.slice(1)}</option>`; 
                }
            });
        }
        
        let currentMarkers = []; 
        function renderMarkers(list) {
            currentMarkers.forEach(marker => marker.setMap(null));
            currentMarkers = [];
            
            list.forEach(p => {
                if (p.lat && p.lon && !isNaN(p.lat) && !isNaN(p.lon)) {
                    const marker = new google.maps.Marker({ position: { lat: p.lat, lng: p.lon }, map: map });
                    marker.addListener('click', () => {
                        const content = `<div class="popup-box"><div class="popup-name">${p.name}</div><div class="popup-city">${p.city}</div></div>`;
                        infoWindow.setContent(content);
                        infoWindow.open({
                            anchor: marker,
                            map,
                        });
                    });
                    currentMarkers.push(marker);
                }
            });
            elements.participantCount.textContent = `${list.length} משתתפים`;
        }
        
        checkAccess();
    </script>
</body>
</html>
